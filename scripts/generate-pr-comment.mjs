#!/usr/bin/env node
/*
 * Copyright Elasticsearch B.V. and contributors
 * SPDX-License-Identifier: Apache-2.0
 */

/*
 * GitHub Action script to generate and post benchmark comparison comments
 * Usage: node scripts/generate-pr-comment.mjs
 */

import { execSync } from 'node:child_process'

function generateComparison(baseDir, prDir) {
  try {
    console.log(`Generating comparison...`)
    const markdown = execSync(
      `node scripts/compare-benchmark-json.mjs "${baseDir}" "${prDir}"`,
      { encoding: 'utf8' }
    )
    return markdown.trim()
  } catch (error) {
    console.error(`Error generating comparison:`, error.message)
    return `## Error\n\nUnable to generate comparison.`
  }
}

async function main() {
  console.log('Generating benchmark comparisons')

  const linuxComparison = generateComparison(
    'benchmark-output/base',
    'benchmark-output/pr'
  )
  execSync(
    `buildkite-agent meta-data set pr_comment:benchmark:head '## Performance benchmark comparison'`,
    { encoding: 'utf8' }
  )

  const commentBody = `
<details>
<summary>Benchmark details (Ubuntu)</summary>

${linuxComparison}

</details>
---

*This comment was automatically generated by the comparative benchmark workflow.*
`
  execSync(
    `buildkite-agent meta-data set pr_comment:benchmark:body '${commentBody}'`,
    { encoding: 'utf8' }
  )
}

main().catch(err => {
  console.error('Error:', err.message)
  process.exit(1)
})
