#!/usr/bin/env node
/*
 * Copyright Elasticsearch B.V. and contributors
 * SPDX-License-Identifier: Apache-2.0
 */

/*
 * GitHub Action script to generate and post benchmark comparison comments
 * Usage: node scripts/generate-pr-comment.mjs
 * Environment variables: GITHUB_TOKEN, GITHUB_REPOSITORY, GITHUB_ISSUE_NUMBER, GITHUB_BASE_REF, GITHUB_HEAD_REF
 */

import { execSync } from 'child_process'
import { process } from 'process'

const {
  GITHUB_TOKEN,
  GITHUB_REPOSITORY,
  GITHUB_ISSUE_NUMBER,
  GITHUB_BASE_REF,
  GITHUB_HEAD_REF
} = process.env

if (!GITHUB_TOKEN || !GITHUB_REPOSITORY || !GITHUB_ISSUE_NUMBER) {
  console.error('Missing required environment variables')
  process.exit(1)
}

const [owner, repo] = GITHUB_REPOSITORY.split('/')

async function githubRequest(endpoint, options = {}) {
  const url = `https://api.github.com${endpoint}`
  const response = await fetch(url, {
    headers: {
      'Authorization': `token ${GITHUB_TOKEN}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json',
      ...options.headers
    },
    ...options
  })

  if (!response.ok) {
    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`)
  }

  return response.json()
}

function generateComparison(os, baseFile, prFile) {
  try {
    console.log(`Generating ${os} comparison...`)
    const markdown = execSync(
      `node scripts/compare-benchmark-json.mjs "${baseFile}" "${prFile}"`,
      { encoding: 'utf8' }
    )
    return markdown.trim()
  } catch (error) {
    console.error(`Error generating ${os} comparison:`, error.message)
    return `## ${os}\n\nUnable to generate comparison for ${os}.`
  }
}

async function main() {
  console.log('Generating benchmark comparisons')

  const linuxComparison = generateComparison(
    'Linux',
    'artifacts/benchmark-ubuntu-latest-base/result.json',
    'artifacts/benchmark-ubuntu-latest-pr/result.json'
  )

  const windowsComparison = generateComparison(
    'Windows',
    'artifacts/benchmark-windows-latest-base/result.json',
    'artifacts/benchmark-windows-latest-pr/result.json'
  )

  const macosComparison = generateComparison(
    'macOS',
    'artifacts/benchmark-macos-latest-base/result.json',
    'artifacts/benchmark-macos-latest-pr/result.json'
  )

  const commentBody = `# Performance benchmark comparison

**Base branch:** \`${GITHUB_BASE_REF || 'unknown'}\`
**PR branch:** \`${GITHUB_HEAD_REF || 'unknown'}\`

<details>
<summary>Linux</summary>

${linuxComparison}

</details>

<details>
<summary>Windows</summary>

${windowsComparison}

</details>

<details>
<summary>macOS</summary>

${macosComparison}

</details>

---

*This comment was automatically generated by the comparative benchmark workflow.*
`

  console.log('Looking for existing benchmark comment')
  const comments = await githubRequest(`/repos/${owner}/${repo}/issues/${GITHUB_ISSUE_NUMBER}/comments`)

  const existingComment = comments.find(comment =>
    comment.body.includes('Performance benchmark comparison') &&
    comment.user.type === 'Bot'
  )

  if (existingComment) {
    console.log('Updating existing comment...')
    await githubRequest(`/repos/${owner}/${repo}/issues/comments/${existingComment.id}`, {
      method: 'PATCH',
      body: JSON.stringify({ body: commentBody })
    })
    console.log('Comment updated successfully')
  } else {
    console.log('Creating new comment...')
    await githubRequest(`/repos/${owner}/${repo}/issues/${GITHUB_ISSUE_NUMBER}/comments`, {
      method: 'POST',
      body: JSON.stringify({ body: commentBody })
    })
    console.log('Comment created successfully')
  }
}

main().catch(err => {
  console.error('Error:', error.message)
  process.exit(1)
})
